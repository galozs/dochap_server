{% extends "base.html" %} 
{% import "bootstrap/wtf.html" as wtf %} 
{% block title %}File Upload{% endblock title %} 
{% block content %} 
<div class = "container"> 
{{ wtf.quick_form(form,action=url_for('api_gtf_upload'),method="post") }} 
<br>
<div class="row">
    <div class="col-md-4">
    </div>
    <div class="col-md-4">
        <select id="transcriptSelect"> </select>
    </div>
    <div class="col-md-4">
        <button class="btn-primary" id="addButton" onclick="chooseClicked();">Choose</button>
    </div>
</div>
<div id="selectedGenes">
</div>

</div> 
{{ super() }} 
{% endblock content %} 
{% block scripts %}
    <script>
        var transcriptsInformation = {}; 
        var transcriptsByGene = {};
        var genesNames = null;

        function fileUploadCallback(){
            var file = document.getElementById("gtfUpload").files[0];
            var name = file.name;
            var fileSize = file.size;
            if (fileSize > 10000000){
                alert("file " + name+ " Is over the size limit (10mb)");
            }
            var reader = new FileReader();
            reader.readAsText(file);
            reader.onload = function(e){ readCallback(e);}
        }

        function readCallback(e){
            var result = e.target.result;
            var lines = result.split('\n');
            for (var i = 0; i < lines.length; i++){
                var line = lines[i];
                var splitLine = line.split('\t');
                if (splitLine[2] == 'transcript'){
                    // get the transcript id and gene name
                    var transcriptParams = splitLine[8].split(' ');
                    var data = {};
                    var geneIndex = transcriptParams.indexOf("gene_id");
                    var geneValue = transcriptParams[geneIndex+1];
                    if (geneValue){
                        data['gene_id'] = geneValue.replace(/[\";]/g,'');
                    }
                    var t_index = transcriptParams.indexOf('transcript_id');
                    var t_value = transcriptParams[t_index+1];
                    if (t_value){
                        data['transcript_id'] = t_value.replace(/[\";]/g,'');
                    }
                    var fpkm_index = transcriptParams.indexOf('FPKM');
                    var fpkm_value = transcriptParams[fpkm_index+1];
                    if (fpkm_value){
                        fpkm_value = parseFloat(fpkm_value.replace(/[\";]/g,''));
                        data['fpkm'] = fpkm_value;
                    } else{
                        data['fpkm'] = 0;
                    }
                    if (! Array.isArray(transcriptsByGene[data['gene_id']])){
                        transcriptsByGene[data['gene_id']] = [];
                    }
                    console.log(data);
                    transcriptsByGene[data['gene_id']].push(data['transcript_id']);
                    transcriptsInformation[data['transcript_id']] = data;
                }

            }
            
            genesNames = Object.keys(transcriptsByGene);
        }

        function search(searchString){ 
            var matcher = new FuzzyMatch(searchString);
            var counter = 0;
            var maxSearches = 100;
            for (var i=0; i < genesNames.length; i++){
                if (counter > maxSearches){
                    return false;
                }
                if (matcher.match(genesNames[i])){
                    // TODO - add to options for autocompelete or something
                    counter++; 
                }
            }
        }

        function chooseGene(geneName){
            var transcripts = transcriptsByGene[geneName]; 
            var transcriptsData=[];
            var orderedTranscripts = [];
            for (var i = 0; i< transcripts.length; i++){
                var data = {
                    'transcript':transcripts[i],
                    'fpkm': transcriptsInformation[transcripts[i]]['fpkm']
                };
                transcriptsData.push(data);
            }
            transcriptsData.sort(function(t1,t2){
                return t2['fpkm'] - t1['fpkm'];
            });
            clearAndFillSelect('transcriptSelect', transcriptsData, true);
            // create related options
        }

        function clearAndFillSelect(select_id, options, use_keys=false){
            var selectElement = document.getElementById(select_id);
            for (var i = selectElement.options.length - 1; i>=0; i--){
                selectElement.remove(i);
            }
            for (var i=0; i<options.length; i++){
                var option = document.createElement("option");
                if (use_keys){
                    option.text = options[i]['transcript'] + ' ' + options[i]['fpkm'];
                    option.value = options[i]['transcript'];
                } else{
                    option.text = options[i];
                    option.value = options[i];
                }
                selectElement.appendChild(option);
            }

        }

        function chooseClicked(){
            console.log('chosen');
        }

        class FuzzyMatch(){
            constructor(searchString){
                this.pattern = new RegExp('('+searchString.split('').join(').*?(')+').*?', 'i');
            }

            match(someString){
                return someString.match(this.pattern) != null;
            }
        }

    </script>
{% endblock %}
